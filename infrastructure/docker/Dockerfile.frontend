# Dockerfile for React frontend application with Vite
FROM node:20-alpine AS base

# Install dependencies for building
FROM base AS deps
WORKDIR /app

# Copy package files
COPY apps/frontend/package.json apps/frontend/package-lock.json* ./

# Install all dependencies (including dev dependencies for build)
# Use --legacy-peer-deps to resolve ESLint 9 peer dependency conflicts
RUN npm ci --legacy-peer-deps && npm cache clean --force

# Build the application
FROM base AS builder
WORKDIR /app

# Copy package files
COPY apps/frontend/package.json apps/frontend/package-lock.json* ./

# Install dependencies
# Use --legacy-peer-deps to resolve ESLint 9 peer dependency conflicts
RUN npm ci --legacy-peer-deps

# Copy source code and configuration files
COPY apps/frontend/ ./

# Build the application
RUN npm run build

# Production image with dev server for development
FROM base AS runner
WORKDIR /app

ENV NODE_ENV=development

# Install curl for health checks and waiting for backend
RUN apk add --no-cache curl

# Create non-root user
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 vite

# Copy package files
COPY apps/frontend/package.json apps/frontend/package-lock.json* ./

# Install all dependencies (needed for dev server and seed script)
# Use --legacy-peer-deps to resolve ESLint 9 peer dependency conflicts
RUN npm ci --legacy-peer-deps && npm cache clean --force

# Copy built application
COPY --from=builder --chown=vite:nodejs /app/dist ./dist

# Copy source code (needed for dev server in development mode)
COPY --chown=vite:nodejs apps/frontend/ ./

# Create startup script that runs seed in parallel
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'set -e' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# Wait for backend to be ready' >> /app/start.sh && \
    echo 'echo "â³ Waiting for backend to be ready..."' >> /app/start.sh && \
    echo 'MAX_WAIT=120' >> /app/start.sh && \
    echo 'WAIT_COUNT=0' >> /app/start.sh && \
    echo 'while [ $WAIT_COUNT -lt $MAX_WAIT ]; do' >> /app/start.sh && \
    echo '  if curl -f -s http://backend:3000/health/live > /dev/null 2>&1; then' >> /app/start.sh && \
    echo '    echo "âœ… Backend is ready!"' >> /app/start.sh && \
    echo '    break' >> /app/start.sh && \
    echo '  fi' >> /app/start.sh && \
    echo '  echo "   Backend not ready, waiting... ($WAIT_COUNT/$MAX_WAIT)"' >> /app/start.sh && \
    echo '  sleep 2' >> /app/start.sh && \
    echo '  WAIT_COUNT=$((WAIT_COUNT + 2))' >> /app/start.sh && \
    echo 'done' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo 'if [ $WAIT_COUNT -ge $MAX_WAIT ]; then' >> /app/start.sh && \
    echo '  echo "âš ï¸  Backend did not become ready in time, continuing anyway..."' >> /app/start.sh && \
    echo 'fi' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# Run seed script in background (non-blocking)' >> /app/start.sh && \
    echo 'echo "ðŸŒ± Starting seed script in background..."' >> /app/start.sh && \
    echo '# Seed script runs in Node.js, can use service names directly' >> /app/start.sh && \
    echo 'SEED_BACKEND_STANDALONE=true VITE_API_URL=http://backend:3000 npm run seed > /tmp/seed.log 2>&1 &' >> /app/start.sh && \
    echo 'SEED_PID=$!' >> /app/start.sh && \
    echo 'echo "   Seed script started with PID $SEED_PID (logs: /tmp/seed.log)"' >> /app/start.sh && \
    echo '' >> /app/start.sh && \
    echo '# Start Vite dev server (this is the main process)' >> /app/start.sh && \
    echo '# Frontend app uses relative URLs (empty VITE_API_URL) to go through Vite proxy' >> /app/start.sh && \
    echo 'echo "ðŸš€ Starting Vite dev server..."' >> /app/start.sh && \
    echo 'unset VITE_API_URL' >> /app/start.sh && \
    echo 'exec npm run dev -- --host 0.0.0.0' >> /app/start.sh && \
    chmod +x /app/start.sh

USER vite

EXPOSE 3001

HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
  CMD node -e "require('http').get('http://localhost:3001', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"

CMD ["sh", "/app/start.sh"]
